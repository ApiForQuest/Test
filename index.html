<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Metascope → Discord Poller (Browser)</title>
  <style>
    body {
      font-family: monospace;
      background: #0f0f0f;
      color: #0f0;
      padding: 20px;
      line-height: 1.5;
    }
    #log {
      background: #111;
      padding: 12px;
      border: 1px solid #333;
      height: 320px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
      margin: 8px 0;
      cursor: pointer;
    }
    #status {
      font-weight: bold;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<h2>Metascope API → Discord Poller</h2>

<p>
  <strong>API:</strong> https://metascope.org/api/apps/gen?app_id=9092019690921877<br>
  <strong>Interval:</strong> ~2 seconds<br>
  <strong>Deduplication:</strong> via SHA-256 of canonical JSON + localStorage
</p>

<div id="status">Status: stopped</div>

<button id="startBtn">Start polling</button>
<button id="stopBtn" disabled>Stop polling</button>
<button id="clearHashesBtn">Clear seen hashes</button>

<div id="log">Log will appear here...\n</div>

<script>
// ────────────────────────────────────────────────
//  CONFIG
// ────────────────────────────────────────────────
const API_URL    = "https://metascope.org/api/apps/gen?app_id=9092019690921877";
const WEBHOOK_URL = "https://discord.com/api/webhooks/1461099803789492298/MHxU7LPJRmsLY2L5G5NnEvhH2Oj6XH-_jrzWek48H9oNzRS900d2uf19Yzmb13XXRWgc";
const INTERVAL_MS = 2000;
const STORAGE_KEY = "metascope_seen_hashes";   // localStorage key
const MAX_ERRORS  = 12;

// ────────────────────────────────────────────────
//  Helpers
// ────────────────────────────────────────────────
function log(msg) {
  const logEl = document.getElementById("log");
  const time = new Date().toLocaleTimeString();
  logEl.textContent += `[${time}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(text) {
  document.getElementById("status").textContent = `Status: ${text}`;
}

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hashBuf = await crypto.subtle.digest("SHA-256", buf);
  const hashArray = Array.from(new Uint8Array(hashBuf));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

function getCanonicalJson(data) {
  // Sort keys + compact (no whitespace)
  return JSON.stringify(data, Object.keys(data).sort());
}

function loadSeenHashes() {
  try {
    const json = localStorage.getItem(STORAGE_KEY);
    return json ? new Set(JSON.parse(json)) : new Set();
  } catch {
    return new Set();
  }
}

function saveSeenHashes(hashesSet) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...hashesSet]));
  } catch (err) {
    log(`localStorage save failed: ${err}`);
  }
}

async function sendToDiscord(data) {
  const payload = {
    content: null,
    embeds: [{
      title: "metascope API Update",
      description: "```json\n" + JSON.stringify(data, null, 2).slice(0, 3900) + "\n```",
      color: 0x57F287,
      timestamp: new Date().toISOString(),
      footer: { text: "~2s polling" }
    }]
  };

  try {
    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      log(`Webhook failed → ${res.status} ${txt.slice(0, 180)}`);
      return false;
    }
    return true;
  } catch (err) {
    log(`Webhook error: ${err}`);
    return false;
  }
}

// ────────────────────────────────────────────────
//  Main logic
// ────────────────────────────────────────────────
let intervalId = null;
let consecutiveErrors = 0;
let seenHashes = loadSeenHashes();

log(`Loaded ${seenHashes.size} previously seen hashes from localStorage`);

async function poll() {
  try {
    const res = await fetch(API_URL, {
      headers: { "Accept": "application/json" }
    });

    if (!res.ok) {
      log(`API error ${res.status}`);
      consecutiveErrors++;
      return;
    }

    let data;
    try {
      data = await res.json();
    } catch {
      log("Response is not valid JSON");
      consecutiveErrors++;
      return;
    }

    const canonical = getCanonicalJson(data);
    const hash = await sha256(canonical);

    if (seenHashes.has(hash)) {
      // log(".");   // uncomment for progress dots
      return;
    }

    // New content
    seenHashes.add(hash);
    saveSeenHashes(seenHashes);

    log("NEW RESPONSE → sending to Discord");

    const success = await sendToDiscord(data);
    if (success) {
      consecutiveErrors = 0;
    } else {
      consecutiveErrors++;
    }

  } catch (err) {
    log(`Request failed: ${err}`);
    consecutiveErrors++;
  }

  if (consecutiveErrors >= MAX_ERRORS) {
    log(`\n${consecutiveErrors} consecutive errors → stopping`);
    stopPolling();
  }
}

function startPolling() {
  if (intervalId) return;
  consecutiveErrors = 0;
  intervalId = setInterval(poll, INTERVAL_MS);
  setStatus("polling");
  document.getElementById("startBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
  log("Polling started");
}

function stopPolling() {
  if (!intervalId) return;
  clearInterval(intervalId);
  intervalId = null;
  setStatus("stopped");
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
  log("Polling stopped");
}

function clearHashes() {
  seenHashes.clear();
  localStorage.removeItem(STORAGE_KEY);
  log("Seen hashes cleared");
}

// ────────────────────────────────────────────────
//  Buttons
// ────────────────────────────────────────────────
document.getElementById("startBtn").onclick = startPolling;
document.getElementById("stopBtn").onclick  = stopPolling;
document.getElementById("clearHashesBtn").onclick = clearHashes;

// Optional: start automatically (comment out if unwanted)
// startPolling();

</script>
</body>
</html>
